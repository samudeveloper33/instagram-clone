{% extends 'base.html' %}
{% block content %}
<div class="bg-gray-50 min-h-screen w-full max-w-full overflow-x-hidden">
  <div class="w-full max-w-6xl mx-auto px-4 py-8">
    <div class="bg-white border border-gray-300 rounded-lg p-6">
      <h1 class="text-xl font-semibold mb-6">Create New Post</h1>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Left side - Upload and Form -->
        <div class="space-y-6">
          <form id="createPostForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Media Upload -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Photos/Videos
              </label>
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <input type="file" id="mediaFiles" name="media_files" multiple accept="image/*,video/*" class="hidden">
                <div id="uploadArea" class="cursor-pointer" onclick="document.getElementById('mediaFiles').click()">
                  <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  <p class="text-gray-500">Click to select photos or videos</p>
                  <p class="text-xs text-gray-400 mt-1">You can select multiple files</p>
                </div>
              </div>
            </div>

            <!-- Caption -->
            <div class="mb-6">
              <label for="caption" class="block text-sm font-medium text-gray-700 mb-2">
                Caption
              </label>
              <textarea 
                id="caption" 
                name="caption" 
                rows="4" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                placeholder="Write a caption..."
                maxlength="2200"
              ></textarea>
              <p class="text-xs text-gray-500 mt-1">
                <span id="captionCount">0</span>/2200 characters
              </p>
            </div>

            <!-- Location -->
            <div class="mb-6">
              <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
                Location (Optional)
              </label>
              <input 
                type="text" 
                id="location" 
                name="location" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Add location..."
                maxlength="100"
              >
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-end space-x-3">
              <a href="{% url 'home' %}" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                Cancel
              </a>
              <button 
                type="submit" 
                id="submitBtn"
                class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                disabled
              >
                Share Post
              </button>
            </div>
          </form>
        </div>

        <!-- Right side - Preview -->
        <div class="flex justify-center lg:justify-start">
          <div class="w-full max-w-sm">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Preview</h3>
            <div id="postPreview" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
              <!-- Post Header -->
              <div class="flex items-center p-3 border-b border-gray-200">
                <div class="w-8 h-8 bg-gray-300 rounded-full flex-shrink-0"></div>
                <div class="ml-3 flex-1">
                  <p class="text-sm font-medium text-gray-900">{{ user.username }}</p>
                  <p id="previewLocation" class="text-xs text-gray-500"></p>
                </div>
              </div>
              
              <!-- Media Preview -->
              <div id="mediaPreviewContainer" class="relative aspect-square bg-gray-100">
                <!-- Default preview state -->
                <div id="previewPlaceholder" class="flex items-center justify-center h-full text-gray-400">
                  <div class="text-center">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2z"/>
                    </svg>
                    <p class="text-sm">Your post preview</p>
                    <p class="text-xs mt-1">Upload media to see preview</p>
                  </div>
                </div>
                
                <!-- Actual media preview -->
                <div id="actualMediaPreview" class="hidden w-full h-full">
                  <div id="mediaCarousel" class="relative w-full h-full">
                    <div id="mediaSlides" class="w-full h-full"></div>
                    
                    <!-- Carousel indicators -->
                    <div id="carouselIndicators" class="hidden absolute bottom-3 left-1/2 transform -translate-x-1/2 flex space-x-1"></div>
                    
                    <!-- Navigation arrows for multiple media -->
                    <button id="prevBtn" class="hidden absolute left-2 top-1/2 transform -translate-y-1/2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-black/70">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                      </svg>
                    </button>
                    <button id="nextBtn" class="hidden absolute right-2 top-1/2 transform -translate-y-1/2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-black/70">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Post Actions -->
              <div class="p-3">
                <div class="flex items-center space-x-4 mb-2">
                  <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                  </svg>
                  <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                  </svg>
                </div>
                
                <!-- Caption Preview -->
                <div id="captionPreviewContainer" class="hidden">
                  <p class="text-sm">
                    <span class="font-medium">{{ user.username }}</span>
                    <span id="previewCaption" class="ml-1"></span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const mediaFiles = document.getElementById('mediaFiles');
  const captionTextarea = document.getElementById('caption');
  const captionCount = document.getElementById('captionCount');
  const locationInput = document.getElementById('location');
  const submitBtn = document.getElementById('submitBtn');
  const form = document.getElementById('createPostForm');
  
  // Preview elements
  const previewPlaceholder = document.getElementById('previewPlaceholder');
  const actualMediaPreview = document.getElementById('actualMediaPreview');
  const mediaSlides = document.getElementById('mediaSlides');
  const carouselIndicators = document.getElementById('carouselIndicators');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const previewCaption = document.getElementById('previewCaption');
  const captionPreviewContainer = document.getElementById('captionPreviewContainer');
  const previewLocation = document.getElementById('previewLocation');
  
  let currentSlide = 0;
  let totalSlides = 0;

  // Handle file selection
  mediaFiles.addEventListener('change', function() {
    const files = Array.from(this.files);
    
    if (files.length > 0) {
      showMediaPreview(files);
      submitBtn.disabled = false;
    } else {
      hideMediaPreview();
      submitBtn.disabled = true;
    }
  });

  // Handle caption input and character count
  captionTextarea.addEventListener('input', function() {
    const text = this.value;
    captionCount.textContent = text.length;
    
    // Update preview caption in real-time
    previewCaption.textContent = text;
    
    // Show/hide caption container based on content
    if (text.trim()) {
      captionPreviewContainer.classList.remove('hidden');
    } else {
      captionPreviewContainer.classList.add('hidden');
    }
  });

  // Handle location input
  locationInput.addEventListener('input', function() {
    const text = this.value;
    previewLocation.textContent = text;
  });

  // Handle form submission
  form.addEventListener('submit', function(e) {
    const files = mediaFiles.files;
    
    if (files.length === 0) {
      e.preventDefault();
      alert('Please select at least one photo or video');
      return;
    }
    
    // Disable submit button to prevent double submission
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sharing...';
  });

  // Carousel navigation
  prevBtn.addEventListener('click', function() {
    if (currentSlide > 0) {
      currentSlide--;
      updateCarousel();
    }
  });

  nextBtn.addEventListener('click', function() {
    if (currentSlide < totalSlides - 1) {
      currentSlide++;
      updateCarousel();
    }
  });

  function showMediaPreview(files) {
    // Hide placeholder and show preview
    previewPlaceholder.classList.add('hidden');
    actualMediaPreview.classList.remove('hidden');
    
    // Clear previous slides
    mediaSlides.innerHTML = '';
    carouselIndicators.innerHTML = '';
    
    totalSlides = files.length;
    currentSlide = 0;
    
    // Create slides container
    const slidesContainer = document.createElement('div');
    slidesContainer.className = 'flex transition-transform duration-300 ease-in-out w-full h-full';
    slidesContainer.style.width = `${totalSlides * 100}%`;
    
    // Create slides
    files.forEach((file, index) => {
      const slide = document.createElement('div');
      slide.className = 'w-full h-full flex-shrink-0';
      slide.style.width = `${100 / totalSlides}%`;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        if (file.type.startsWith('image/')) {
          slide.innerHTML = `
            <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-full object-cover">
          `;
        } else if (file.type.startsWith('video/')) {
          slide.innerHTML = `
            <video src="${e.target.result}" class="w-full h-full object-cover" muted>
            </video>
          `;
        }
      };
      reader.readAsDataURL(file);
      
      slidesContainer.appendChild(slide);
      
      // Create indicator
      if (totalSlides > 1) {
        const indicator = document.createElement('div');
        indicator.className = `w-2 h-2 rounded-full cursor-pointer ${index === 0 ? 'bg-blue-500' : 'bg-gray-300'}`;
        indicator.addEventListener('click', () => {
          currentSlide = index;
          updateCarousel();
        });
        carouselIndicators.appendChild(indicator);
      }
    });
    
    mediaSlides.appendChild(slidesContainer);
    
    // Show/hide navigation elements based on number of files
    if (totalSlides > 1) {
      carouselIndicators.classList.remove('hidden');
      prevBtn.classList.remove('hidden');
      nextBtn.classList.remove('hidden');
    } else {
      carouselIndicators.classList.add('hidden');
      prevBtn.classList.add('hidden');
      nextBtn.classList.add('hidden');
    }
    
    updateCarousel();
  }

  function hideMediaPreview() {
    // Show placeholder and hide preview
    previewPlaceholder.classList.remove('hidden');
    actualMediaPreview.classList.add('hidden');
    
    // Clear content
    mediaSlides.innerHTML = '';
    carouselIndicators.innerHTML = '';
    
    // Reset carousel state
    currentSlide = 0;
    totalSlides = 0;
  }

  function updateCarousel() {
    const slidesContainer = mediaSlides.querySelector('div');
    if (slidesContainer) {
      const translateX = -(currentSlide * (100 / totalSlides));
      slidesContainer.style.transform = `translateX(${translateX}%)`;
    }
    
    // Update indicators
    const indicators = carouselIndicators.querySelectorAll('div');
    indicators.forEach((indicator, index) => {
      if (index === currentSlide) {
        indicator.classList.remove('bg-gray-300');
        indicator.classList.add('bg-blue-500');
      } else {
        indicator.classList.remove('bg-blue-500');
        indicator.classList.add('bg-gray-300');
      }
    });
    
    // Update navigation button states
    prevBtn.style.opacity = currentSlide === 0 ? '0.5' : '1';
    nextBtn.style.opacity = currentSlide === totalSlides - 1 ? '0.5' : '1';
  }
});

function removeFile(index) {
  // This is a simplified version - in a real app you'd want to properly manage file removal
  alert('File removal not implemented in this demo. Please reselect your files.');
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
