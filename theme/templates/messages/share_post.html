{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto px-4 py-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Share Post</h1>
    <a href="{% url 'post_detail' post.id %}" class="text-gray-600 hover:text-gray-800 transition-colors">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </a>
  </div>

  <!-- Post Preview -->
  <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
    <div class="flex items-center space-x-3 mb-3">
      {% if post.user.profile.profile_picture %}
        <img src="{{ post.user.profile.profile_picture.url }}" alt="{{ post.user.username }}" class="w-10 h-10 rounded-full object-cover">
      {% else %}
        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
          <span class="text-white font-semibold">{{ post.user.username|first|upper }}</span>
        </div>
      {% endif %}
      <div>
        <h3 class="font-semibold text-gray-900">{{ post.user.username }}</h3>
        <p class="text-sm text-gray-500">{{ post.created_at|timesince }} ago</p>
      </div>
    </div>
    
    {% if post.get_first_media %}
      <img src="{{ post.get_first_media.media_file.url }}" alt="Post" class="w-full h-48 object-cover rounded-lg mb-3">
    {% endif %}
    
    {% if post.caption %}
      <p class="text-gray-900">{{ post.caption|truncatewords:20 }}</p>
    {% endif %}
  </div>

  <!-- Share Form -->
  <form method="POST" class="space-y-6">
    {% csrf_token %}
    
    <!-- Message Input -->
    <div>
      <label for="message_text" class="block text-sm font-medium text-gray-700 mb-2">Add a message (optional)</label>
      <textarea 
        name="message_text" 
        id="message_text"
        placeholder="Write a message..." 
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        rows="3"
      ></textarea>
    </div>
    
    <!-- Recent Chats -->
    {% if recent_users %}
      <div>
        <h3 class="text-lg font-semibold text-gray-900 mb-3">Recent Chats</h3>
        <div class="space-y-2">
          {% for user in recent_users %}
            <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
              <input type="checkbox" name="user_ids" value="{{ user.id }}" class="mr-3 text-blue-500 focus:ring-blue-500">
              
              {% if user.profile.profile_picture %}
                <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.username }}" class="w-10 h-10 rounded-full object-cover mr-3">
              {% else %}
                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mr-3">
                  <span class="text-white font-semibold">{{ user.username|first|upper }}</span>
                </div>
              {% endif %}
              
              <div class="flex-1">
                <p class="font-medium text-gray-900">{{ user.username }}</p>
                {% if user.first_name or user.last_name %}
                  <p class="text-sm text-gray-500">{{ user.first_name }} {{ user.last_name }}</p>
                {% endif %}
              </div>
            </label>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    
    <!-- Search for More Users -->
    <div>
      <h3 class="text-lg font-semibold text-gray-900 mb-3">Send to Others</h3>
      <div class="mb-3">
        <input 
          type="text" 
          id="userSearch" 
          placeholder="Search for users..." 
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
      </div>
      
      <div id="searchResults" class="space-y-2 max-h-60 overflow-y-auto">
        <!-- Search results will be populated here -->
      </div>
    </div>
    
    <!-- Submit Button -->
    <div class="flex items-center justify-between pt-4 border-t border-gray-200">
      <a href="{% url 'post_detail' post.id %}" class="text-gray-600 hover:text-gray-800 transition-colors">Cancel</a>
      <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-6 py-2 rounded-lg transition-colors">
        Share Post
      </button>
    </div>
  </form>
</div>

<script>
// User search functionality
let searchTimeout;
document.getElementById('userSearch').addEventListener('input', function() {
  const query = this.value.trim();
  
  clearTimeout(searchTimeout);
  
  if (query.length < 2) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  
  searchTimeout = setTimeout(() => {
    fetch(`/messages/search-users/?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';
        
        data.users.forEach(user => {
          const userDiv = document.createElement('label');
          userDiv.className = 'flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer';
          
          userDiv.innerHTML = `
            <input type="checkbox" name="user_ids" value="${user.id}" class="mr-3 text-blue-500 focus:ring-blue-500">
            
            <div class="w-10 h-10 rounded-full overflow-hidden mr-3">
              ${user.profile_picture ? 
                `<img src="${user.profile_picture}" alt="${user.username}" class="w-full h-full object-cover">` :
                `<div class="w-full h-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                  <span class="text-white font-semibold">${user.username.charAt(0).toUpperCase()}</span>
                </div>`
              }
            </div>
            
            <div class="flex-1">
              <p class="font-medium text-gray-900">${user.username}</p>
              ${user.full_name !== user.username ? `<p class="text-sm text-gray-500">${user.full_name}</p>` : ''}
            </div>
          `;
          
          resultsContainer.appendChild(userDiv);
        });
        
        if (data.users.length === 0) {
          resultsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No users found</p>';
        }
      })
      .catch(error => {
        console.error('Search error:', error);
      });
  }, 300);
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
  const checkedUsers = document.querySelectorAll('input[name="user_ids"]:checked');
  
  if (checkedUsers.length === 0) {
    e.preventDefault();
    alert('Please select at least one user to share with.');
    return false;
  }
});
</script>
{% endblock %}
