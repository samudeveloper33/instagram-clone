{% extends 'base.html' %}
{% block content %}
<div class="flex h-screen bg-white border border-gray-300 rounded-lg overflow-hidden max-w-7xl mx-auto my-4">
  <!-- Left Sidebar - Chat List (same as messages_home) -->
  <div class="w-96 border-r border-gray-300 flex flex-col bg-white">
    <!-- Sidebar Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-300">
      <div class="flex items-center space-x-2">
        <h1 class="text-base font-semibold text-gray-900">{{ request.user.username }}</h1>
        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </div>
      <a href="{% url 'messages_home' %}" class="p-1 hover:bg-gray-100 rounded-full transition-colors">
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
        </svg>
      </a>
    </div>
    
    <!-- Messages Tab -->
    <div class="px-4 border-b border-gray-300">
      <div class="py-3 text-center text-sm font-semibold text-gray-900 border-b-2 border-gray-900">
        Messages
      </div>
    </div>
    
    <!-- Quick Thread List -->
    <div class="flex-1 overflow-y-auto">
      <a href="{% url 'chat_thread' thread.id %}" class="flex items-center px-4 py-3 bg-gray-100 hover:bg-gray-50 transition-colors">
        {% if other_participant.profile.profile_picture %}
          <img src="{{ other_participant.profile.profile_picture.url }}" alt="{{ other_participant.username }}" class="w-14 h-14 rounded-full object-cover mr-3">
        {% else %}
          <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mr-3">
            <span class="text-white text-lg font-semibold">{{ other_participant.username|first|upper }}</span>
          </div>
        {% endif %}
        <div class="flex-1">
          <h3 class="font-medium text-gray-900 text-sm">{{ other_participant.username }}</h3>
          <p class="text-xs text-gray-500 truncate">Active now</p>
        </div>
      </a>
    </div>
  </div>

  <!-- Right Side - Chat Conversation -->
  <div class="flex-1 flex flex-col bg-white">
    <!-- Chat Header -->
    <div class="border-b border-gray-300 px-6 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <!-- User Info -->
        {% if other_participant %}
          <a href="{% url 'profile' other_participant.username %}" class="flex items-center space-x-3">
            {% if other_participant.profile.profile_picture %}
              <img src="{{ other_participant.profile.profile_picture.url }}" alt="{{ other_participant.username }}" class="w-10 h-10 rounded-full object-cover">
            {% else %}
              <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                <span class="text-white font-semibold">{{ other_participant.username|first|upper }}</span>
              </div>
            {% endif %}
            
            <div>
              <h2 class="font-semibold text-gray-900 text-base">{{ other_participant.username }}</h2>
              <p class="text-xs text-gray-500">Active now</p>
            </div>
          </a>
        {% endif %}
      </div>
      
      <!-- Chat Actions -->
      <div class="flex items-center space-x-4">
        <!-- Actions removed as requested -->
      </div>
    </div>
  
    <!-- Messages Area -->
    <div id="messagesArea" class="flex-1 overflow-y-auto p-6 space-y-2 bg-white">
      {% for message in messages %}
        {% if not message.is_deleted %}
          <div class="flex {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %}">
            <div class="max-w-xs">
              <!-- Message Bubble -->
              <div class="{% if message.sender == request.user %}bg-blue-500 text-white{% else %}border border-gray-300 text-gray-900{% endif %} rounded-3xl px-4 py-2">
              
              <!-- Text Message -->
              {% if message.message_type == 'text' %}
                <p class="text-sm">{{ message.text }}</p>
              
              <!-- Image Message -->
              {% elif message.message_type == 'image' %}
                <div class="mb-2">
                  <img src="{{ message.attachment.url }}" alt="Image" class="rounded-lg max-w-full h-auto">
                </div>
                {% if message.text %}
                  <p class="text-sm">{{ message.text }}</p>
                {% endif %}
              
              <!-- Video Message -->
              {% elif message.message_type == 'video' %}
                <div class="mb-2">
                  <video controls class="rounded-lg max-w-full h-auto">
                    <source src="{{ message.attachment.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                </div>
                {% if message.text %}
                  <p class="text-sm">{{ message.text }}</p>
                {% endif %}
              
              <!-- File Message -->
              {% elif message.message_type == 'file' %}
                <div class="flex items-center space-x-2 mb-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <a href="{{ message.attachment.url }}" download class="text-sm underline">{{ message.attachment_name }}</a>
                </div>
                {% if message.text %}
                  <p class="text-sm">{{ message.text }}</p>
                {% endif %}
              
              <!-- Shared Post -->
              {% elif message.message_type == 'post_share' %}
                <div class="border border-gray-200 rounded-lg p-3 mb-2 bg-white">
                  <div class="flex items-center space-x-2 mb-2">
                    <img src="{{ message.shared_post.user.profile.profile_picture.url|default:'/static/default-avatar.png' }}" alt="{{ message.shared_post.user.username }}" class="w-6 h-6 rounded-full">
                    <span class="text-sm font-medium text-gray-900">{{ message.shared_post.user.username }}</span>
                  </div>
                  {% if message.shared_post.get_first_media %}
                    <img src="{{ message.shared_post.get_first_media.media_file.url }}" alt="Shared post" class="rounded-lg w-full h-32 object-cover mb-2">
                  {% endif %}
                  <p class="text-sm text-gray-600">{{ message.shared_post.caption|truncatewords:10 }}</p>
                  <a href="{% url 'post_detail' message.shared_post.id %}" class="text-blue-500 text-sm">View Post</a>
                </div>
                {% if message.text %}
                  <p class="text-sm">{{ message.text }}</p>
                {% endif %}
              {% endif %}
            </div>
            
            <!-- Message Info -->
            <div class="flex items-center {% if message.sender == request.user %}justify-end{% else %}justify-start{% endif %} mt-1 space-x-2">
              <span class="text-xs text-gray-500">{{ message.created_at|date:"H:i" }}</span>
              {% if message.sender == request.user %}
              <button onclick="deleteMessage('{{ message.id }}')" class="text-xs text-gray-400 hover:text-red-500">Delete</button>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    {% empty %}
      <div class="text-center py-8">
        <p class="text-gray-500">No messages yet. Start the conversation!</p>
      </div>
    {% endfor %}
  </div>
  
    <!-- Message Input -->
    <div class="bg-white border-t border-gray-300 px-6 py-3">
      <form method="POST" action="{% url 'send_message' thread.id %}" enctype="multipart/form-data" id="messageForm" class="flex items-center space-x-3">
        {% csrf_token %}
        
        <!-- Message Input -->
        <div class="flex-1 relative">
          <input 
            type="text"
            name="message_text" 
            id="messageInput"
            placeholder="Message..." 
            class="w-full px-4 py-2 border border-gray-300 rounded-full resize-none focus:outline-none focus:border-gray-400"
            style="font-size: 14px;"
          />
          <input type="file" id="fileInput" name="attachment" class="hidden" accept="image/*,video/*,.pdf,.doc,.docx">
        </div>
        
        <!-- Action Buttons -->
        <button type="button" onclick="document.getElementById('fileInput').click()" class="text-gray-600 hover:text-gray-800 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </button>
        
        <!-- Send Button -->
        <button type="submit" id="sendButton" class="text-blue-500 hover:text-blue-600 font-semibold text-sm transition-colors">
          Send
        </button>
      </form>
    </div>
  </div>
</div>

<script>
// Auto-resize textarea
const messageInput = document.getElementById('messageInput');
messageInput.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// Handle Enter key
messageInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('messageForm').submit();
  }
});

// File input handling
document.getElementById('fileInput').addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('filePreview').classList.remove('hidden');
  }
});

function clearFileInput() {
  document.getElementById('fileInput').value = '';
  document.getElementById('filePreview').classList.add('hidden');
}

// Scroll to bottom
function scrollToBottom() {
  const messagesArea = document.getElementById('messagesArea');
  messagesArea.scrollTop = messagesArea.scrollHeight;
}

// Scroll to bottom on page load
window.addEventListener('load', scrollToBottom);

// Delete message
function deleteMessage(messageId) {
  if (confirm('Are you sure you want to delete this message?')) {
    fetch(`/messages/delete/${messageId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }
}

// Delete chat
function deleteChat() {
  if (confirm('Are you sure you want to delete this conversation?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "delete_thread" thread.id %}';
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}

// Mark thread as read when page loads
fetch('{% url "mark_thread_read" thread.id %}', {
  method: 'POST',
  headers: {
    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
  }
});
</script>
{% endblock %}
