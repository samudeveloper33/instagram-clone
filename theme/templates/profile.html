{% extends 'base.html' %}
{% block content %}
  <div class="bg-gray-50 min-h-screen w-full">
    <div class="w-full max-w-6xl mx-auto px-1 sm:px-2 md:px-3 py-2 md:py-4">
      <!-- Profile Header Section -->
      <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 px-4 py-8 sm:p-6 mb-2 sm:mb-3">
        <div class="flex items-center space-x-2 sm:space-x-3">
          <!-- Profile Picture -->
          <div class="relative flex-shrink-0">
            {% if profile_user.profile.profile_picture %}
              <img src="{{ profile_user.profile.profile_picture.url }}" alt="{{ profile_user.username }}" class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 rounded-full object-cover" />
            {% else %}
              <div class="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                <span class="text-white text-sm sm:text-lg md:text-xl font-bold">{{ profile_user.username|first|upper }}</span>
              </div>
            {% endif %}
            {% if is_own_profile %}
              <button class="absolute -bottom-0.5 -right-0.5 sm:-bottom-1 sm:-right-1 bg-blue-500 rounded-full p-1 sm:p-1.5 shadow-lg">
                <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                </svg>
              </button>
            {% endif %}
          </div>

          <!-- Profile Info -->
          <div class="flex-1 min-w-0">
            <!-- Username and Action Buttons -->
            <div class="flex items-center justify-between mb-1 sm:mb-2">
              <h1 class="text-base sm:text-lg md:text-xl font-bold text-gray-900 truncate">{{ profile_user.username }}</h1>

              {% if is_own_profile %}
                <div class="flex space-x-1">
                  <button class="bg-gray-100 text-gray-700 font-medium py-1 px-2 sm:px-3 rounded text-xs sm:text-sm">Edit</button>
                  <a href="{% url 'create_story' %}" class="bg-blue-500 text-white font-medium py-1 px-2 sm:px-3 rounded text-xs sm:text-sm">Story</a>
                </div>
              {% else %}
                {% if can_see_follow_button %}
                  <div class="flex space-x-1">
                    {% if is_following %}
                      <button onclick="unfollowUser('{{ profile_user.username }}')" class="bg-gray-200 text-gray-700 font-medium py-1 px-2 sm:px-3 rounded text-xs sm:text-sm follow-action-btn">Following</button>
                    {% elif has_pending_request %}
                      <button class="bg-gray-300 text-gray-600 font-medium py-1 px-2 sm:px-3 rounded text-xs sm:text-sm cursor-not-allowed" disabled>Requested</button>
                    {% else %}
                      <button onclick="followUser('{{ profile_user.username }}')" class="bg-blue-500 text-white font-medium py-1 px-2 sm:px-3 rounded text-xs sm:text-sm follow-action-btn">Follow</button>
                    {% endif %}
                  </div>
                {% endif %}
              {% endif %}
            </div>

            <!-- Stats -->
            <div class="flex space-x-2 sm:space-x-4 mb-1 sm:mb-2">
              <div class="text-center">
                <span class="font-semibold text-xs sm:text-sm">{{ post_count }}</span>
                <span class="text-gray-500 text-xs ml-0.5 sm:ml-1">posts</span>
              </div>
              <a href="{% url 'followers' profile_user.username %}" class="text-center">
                <span class="font-semibold text-xs sm:text-sm">{{ followers_count }}</span>
                <span class="text-gray-500 text-xs ml-0.5 sm:ml-1">followers</span>
              </a>
              <a href="{% url 'following' profile_user.username %}" class="text-center">
                <span class="font-semibold text-xs sm:text-sm">{{ following_count }}</span>
                <span class="text-gray-500 text-xs ml-0.5 sm:ml-1">following</span>
              </a>
            </div>

            <!-- Bio -->
            <div>
              {% if profile_user.first_name %}
                <p class="font-medium text-gray-900 text-xs sm:text-sm">{{ profile_user.first_name }} {{ profile_user.last_name }}</p>
              {% endif %}
              {% if profile_user.profile.bio %}
                <p class="text-gray-700 text-xs sm:text-sm">{{ profile_user.profile.bio|truncatewords:10 }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- My Stories Section (only for own profile) -->
      {% if is_own_profile %}
        <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6 mb-2 sm:mb-3">
          <div class="flex items-center justify-between mb-2 sm:mb-3">
            <h2 class="text-base sm:text-lg font-bold text-gray-900">Your Stories</h2>
            <a href="{% url 'create_story' %}" class="text-blue-500 text-xs sm:text-sm font-medium">Create</a>
          </div>

          <div class="flex space-x-2 sm:space-x-3 overflow-x-auto pb-1">
            <!-- Add Story Card -->
            <div class="flex-shrink-0 text-center">
              <a href="{% url 'create_story' %}" class="block">
                <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gray-100 rounded-full flex items-center justify-center border-2 border-dashed border-gray-300">
                  <svg class="w-4 h-4 sm:w-6 sm:h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                  </svg>
                </div>
                <p class="text-xs text-gray-500 mt-1">New</p>
              </a>
            </div>

            <!-- User's Stories -->
            {% for story in user_stories %}
              <div class="flex-shrink-0 text-center">
                <a href="{% url 'story_viewer_specific' profile_user.username story.id %}" class="block">
                  <div class="w-12 h-12 sm:w-16 sm:h-16 rounded-full overflow-hidden border-2 border-purple-500">
                    {% if story.media_type == 'image' %}
                      <img src="{{ story.media_file.url }}" alt="Story" class="w-full h-full object-cover" />
                    {% else %}
                      <video src="{{ story.media_file.url }}" class="w-full h-full object-cover" muted></video>
                    {% endif %}
                  </div>
                  <p class="text-xs text-gray-700 mt-1 hidden sm:block">{{ story.created_at|timesince|truncatewords:1 }}</p>
                </a>
              </div>
            {% endfor %}

            {% if not user_stories %}
              <div class="text-center py-2 sm:py-4 text-gray-500 w-full">
                <p class="text-xs sm:text-sm">No stories yet. Create your first story!</p>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <!-- Navigation Tabs -->
      <div class="border-t border-gray-300">
        <div class="flex justify-center">
          <button class="flex items-center space-x-2 px-6 py-4 border-t border-black -mt-px text-xs font-semibold text-black uppercase tracking-widest">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
            </svg>
            <span>Posts</span>
          </button>

          {% if is_own_profile %}
            <button class="flex items-center space-x-2 px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-widest hover:text-gray-600">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Tagged</span>
            </button>
          {% endif %}
        </div>
      </div>

      <!-- Posts Grid or Private Account Message -->
      {% if can_view_profile %}
        <!-- Posts Grid -->
        {% if user_posts %}
          <div class="grid grid-cols-3 gap-1 md:gap-4 lg:gap-6 mt-4">
            {% for post in user_posts %}
              <div class="aspect-square bg-gray-100 hover:opacity-80 cursor-pointer relative group" 
                   data-post-id="{{ post.id }}"
                   data-post-data='{
                     "id": {{ post.id }},
                     "caption": "{{ post.caption|escapejs }}",
                     "location": "{{ post.location|escapejs }}",
                     "created_at": "{{ post.created_at|date:'c' }}",
                     "likes_count": {{ post.post_likes.count }},
                     "comments_count": {{ post.comments.count }},
                     "author": {
                       "username": "{{ post.user.username|escapejs }}"
                     },
                     "media_files": [
                       {% for media in post.media_files.all %}
                       {
                         "media_file": "{{ media.media_file.url }}",
                         "media_type": "{{ media.media_type }}"
                       }{% if not forloop.last %},{% endif %}
                       {% endfor %}
                     ],
                     "comments": [
                       {% for comment in post.comments.all|slice:":5" %}
                       {
                         "text": "{{ comment.text|escapejs }}",
                         "created_at": "{{ comment.created_at|date:'c' }}",
                         "author": {
                           "username": "{{ comment.user.username|escapejs }}"
                         }
                       }{% if not forloop.last %},{% endif %}
                       {% endfor %}
                     ]
                   }'
                   data-onclick-postid="{{ post.id }}"
                   onclick="openPostModal(this.getAttribute('data-onclick-postid'))">
                
                <!-- Post Options Menu (Three Dots) -->
                {% if post.user.username == user.username %}
                  <div class="absolute top-2 left-2 opacity-100 transition-opacity z-10">
                    <button class="text-white hover:text-gray-300 post-options-btn bg-black bg-opacity-50 rounded-full p-1.5 sm:p-1 touch-manipulation" 
                            data-post-id="{{ post.id }}" 
                            data-post-owner="{{ post.user.username }}"
                            onclick="togglePostOptionsMenu(this.getAttribute('data-post-id')); event.stopPropagation();"
                            style="-webkit-tap-highlight-color: transparent;">
                      <svg class="w-5 h-5 sm:w-4 sm:h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                      </svg>
                    </button>
                    
                    <!-- Dropdown Menu - Complete Instagram-like Options -->
                    <div class="post-options-menu absolute left-0 top-8 sm:left-0 sm:top-8 bg-white rounded-xl shadow-2xl py-2 w-56 sm:w-56 z-50 hidden border-0 touch-manipulation" data-post-id="{{ post.id }}" style="box-shadow: 0 8px 30px rgba(0,0,0,0.12); -webkit-tap-highlight-color: transparent;">
                      <!-- Delete Button (Owner Only) -->
                      <button class="w-full text-left px-4 py-4 text-sm text-red-500 hover:bg-red-50 active:bg-red-100 font-semibold delete-post-btn transition-colors duration-200 touch-manipulation" data-post-id="{{ post.id }}" style="-webkit-tap-highlight-color: transparent;">
                        <span>Delete</span>
                      </button>
                      
                      <div class="border-t border-gray-100 my-1"></div>
                      
                      <!-- Edit Button -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 active:bg-gray-100 font-medium edit-post-btn transition-colors duration-200 touch-manipulation" data-post-id="{{ post.id }}" style="-webkit-tap-highlight-color: transparent;">
                        <span>Edit</span>
                      </button>
                      
                      <!-- Hide like count -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 active:bg-gray-100 font-medium hide-likes-btn transition-colors duration-200 touch-manipulation" data-post-id="{{ post.id }}" style="-webkit-tap-highlight-color: transparent;">
                        <span>Hide like count to others</span>
                      </button>
                      
                      <!-- Turn off commenting -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 active:bg-gray-100 font-medium toggle-comments-btn transition-colors duration-200 touch-manipulation" data-post-id="{{ post.id }}" style="-webkit-tap-highlight-color: transparent;">
                        <span>Turn off commenting</span>
                      </button>
                      
                      <div class="border-t border-gray-100 my-1"></div>
                      
                      <!-- Go to post -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 active:bg-gray-100 font-medium go-to-post-btn transition-colors duration-200 touch-manipulation" data-post-id="{{ post.id }}" style="-webkit-tap-highlight-color: transparent;">
                        <span>Go to post</span>
                      </button>
                      
                      <!-- Share to... -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 active:bg-gray-100 font-medium share-to-btn transition-colors duration-200 touch-manipulation" data-post-id="{{ post.id }}" style="-webkit-tap-highlight-color: transparent;">
                        <span>Share to...</span>
                      </button>
                      
                      <!-- Copy link -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 active:bg-gray-100 font-medium copy-link-btn transition-colors duration-200 touch-manipulation" data-post-id="{{ post.id }}" style="-webkit-tap-highlight-color: transparent;">
                        <span>Copy link</span>
                      </button>
                      
                      <!-- Embed -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 active:bg-gray-100 font-medium embed-btn transition-colors duration-200 touch-manipulation" data-post-id="{{ post.id }}" style="-webkit-tap-highlight-color: transparent;">
                        <span>Embed</span>
                      </button>
                      
                      <!-- About this account -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 active:bg-gray-100 font-medium about-account-btn transition-colors duration-200 touch-manipulation" style="-webkit-tap-highlight-color: transparent;">
                        <span>About this account</span>
                      </button>
                      
                      <div class="border-t border-gray-100 my-1"></div>
                      
                      <!-- Cancel Button -->
                      <button class="w-full text-left px-4 py-4 text-sm text-gray-600 hover:bg-gray-50 active:bg-gray-100 font-medium close-menu-btn transition-colors duration-200 touch-manipulation" style="-webkit-tap-highlight-color: transparent;">
                        <span>Cancel</span>
                      </button>
                    </div>
                  </div>
                {% endif %}
                {% with first_media=post.media_files.first %}
                  {% if first_media %}
                    {% if first_media.media_type == 'image' %}
                      <img src="{{ first_media.media_file.url }}" alt="Post by {{ post.user.username }}" class="w-full h-full object-cover" />
                    {% elif first_media.media_type == 'video' %}
                      <video src="{{ first_media.media_file.url }}" class="w-full h-full object-cover" muted></video>
                      <!-- Video indicator -->
                      <div class="absolute top-2 right-2">
                        <svg class="w-4 h-4 text-white drop-shadow-lg" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                        </svg>
                      </div>
                    {% endif %}
                    
                    <!-- Multiple media indicator -->
                    {% if post.media_files.count > 1 %}
                      <div class="absolute top-2 right-2">
                        <svg class="w-4 h-4 text-white drop-shadow-lg" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                        </svg>
                      </div>
                    {% endif %}
                  {% else %}
                    <!-- Fallback if no media -->
                    <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                      <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                      </svg>
                    </div>
                  {% endif %}
                {% endwith %}
                
                <!-- Hover Overlay -->
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">
                  <div class="flex items-center space-x-6 text-white">
                    <div class="flex items-center space-x-1">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                      </svg>
                      <span class="font-semibold">{{ post.post_likes.count }}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd" />
                      </svg>
                      <span class="font-semibold">{{ post.comments.count }}</span>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <!-- No Posts Message -->
          <div class="text-center py-16">
            <div class="border-2 border-black rounded-full w-16 h-16 mx-auto mb-6 flex items-center justify-center">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
            </div>
            <h2 class="text-3xl font-light mb-2">
              {% if is_own_profile %}
                Share Photos
              {% else %}
                No Posts Yet
              {% endif %}
            </h2>
            <p class="text-gray-500">
              {% if is_own_profile %}
                When you share photos and videos, they will appear on your profile.
              {% else %}
                When {{ profile_user.username }} shares photos and videos, you'll see them here.
              {% endif %}
            </p>
            {% if is_own_profile %}
              <button class="text-blue-500 font-semibold mt-4 hover:text-blue-600">Share your first photo</button>
            {% endif %}
          </div>
        {% endif %}
      {% else %}
        <!-- Private Account Message -->
        <div class="text-center py-16">
          <div class="border-2 border-black rounded-full w-20 h-20 mx-auto mb-6 flex items-center justify-center">
            <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
            </svg>
          </div>
          <h2 class="text-3xl font-light mb-4">This Account is Private</h2>
          <p class="text-gray-500 mb-6">Follow to see their photos and videos.</p>
          {% if not has_pending_request and not is_following %}
            <button onclick="followUser('{{ profile_user.username }}')" class="bg-blue-500 text-white font-semibold px-8 py-2 rounded-md hover:bg-blue-600 transition-colors">Follow</button>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    function followUser(username) {
      const btn = document.querySelector('.follow-action-btn') || event.target
      const originalText = btn.textContent
      btn.textContent = 'Following...'
      btn.disabled = true
    
      fetch(`/follow/send/${username}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            if (data.success.includes('now following')) {
              btn.textContent = 'Following'
              btn.className = 'bg-gray-200 text-gray-700 px-4 py-1 rounded-md text-sm hover:bg-gray-300 follow-action-btn'
              btn.onclick = () => unfollowUser(username)
            } else {
              btn.textContent = 'Requested'
              btn.className = 'bg-gray-400 text-white px-4 py-1 rounded-md text-sm cursor-not-allowed'
              btn.disabled = true
            }
            // Update follower count if visible
            setTimeout(() => location.reload(), 1000)
          } else {
            btn.textContent = originalText
            btn.disabled = false
            alert(data.error || 'Error following user')
          }
        })
        .catch((error) => {
          btn.textContent = originalText
          btn.disabled = false
          alert('Error following user')
        })
    }
    
    function unfollowUser(username) {
      const btn = document.querySelector('.follow-action-btn')
      const originalText = btn.textContent
      btn.textContent = 'Unfollowing...'
      btn.disabled = true
    
      fetch(`/follow/unfollow/${username}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            btn.textContent = 'Follow'
            btn.className = 'bg-blue-500 text-white px-4 py-1 rounded-md text-sm hover:bg-blue-600 follow-action-btn'
            btn.onclick = () => followUser(username)
            btn.disabled = false
            // Update follower count if visible
            setTimeout(() => location.reload(), 1000)
          } else {
            btn.textContent = originalText
            btn.disabled = false
            alert(data.error || 'Error unfollowing user')
          }
        })
        .catch((error) => {
          btn.textContent = originalText
          btn.disabled = false
          alert('Error unfollowing user')
        })
    }
    
    function getCookie(name) {
      let cookieValue = null
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';')
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim()
          if (cookie.substring(0, name.length + 1) === name + '=') {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
            break
          }
        }
      }
      return cookieValue
    }
    
    // Post modal functionality
    function openPostModal(postId) {
      // For now, find the post data from the current page
      const postElement = event.target.closest('[data-post-id]');
      if (postElement) {
        const postData = JSON.parse(postElement.dataset.postData);
        showPostModal(postData);
      } else {
        // Fallback to redirect
        window.location.href = `/posts/${postId}/`;
      }
    }
    
    function showPostModal(post) {
      // Create modal HTML
      const modal = document.createElement('div');
      modal.id = 'postModal';
      modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
      modal.onclick = (e) => {
        if (e.target === modal) closePostModal();
      };
      
      // Get first media for display
      const firstMedia = post.media_files && post.media_files[0];
      const hasMultipleMedia = post.media_files && post.media_files.length > 1;
      
      modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-6xl max-h-[90vh] w-full flex overflow-hidden relative">
          <!-- Close/Cancel Button (Top Right) - X Icon -->
          <button onclick="closePostModal()" class="absolute top-4 right-4 text-gray-700 hover:text-gray-900 z-20 p-2" title="Close">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
          
          <!-- Three Dots Menu Button (Top Right, before close) -->
          <button onclick="toggleModalPostOptions()" class="absolute top-4 right-16 text-gray-700 hover:text-gray-900 z-20 p-2" title="More options">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
            </svg>
          </button>
          
          <!-- Post Navigation Buttons (Side arrows - different style) -->
          <button onclick="navigatePost('prev')" class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-white hover:scale-110 z-20 bg-black rounded-full p-3 shadow-xl transition-transform" title="Previous">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <button onclick="navigatePost('next')" class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-white hover:scale-110 z-20 bg-black rounded-full p-3 shadow-xl transition-transform" title="Next">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
          
          <!-- Media Section -->
          <div class="flex-1 bg-gray-50 flex items-center justify-center relative">
            
            <!-- Media Carousel -->
            <div class="relative w-full h-full max-h-[80vh]" id="mediaCarousel">
              <div class="flex transition-transform duration-300 ease-in-out h-full" id="mediaSlides">
                ${post.media_files ? post.media_files.map((media, index) => `
                  <div class="w-full h-full flex-shrink-0 flex items-center justify-center">
                    ${media.media_type === 'image' ? 
                      `<img src="${media.media_file}" alt="Post media" class="max-w-full max-h-full object-contain">` :
                      `<video src="${media.media_file}" controls class="max-w-full max-h-full object-contain" preload="metadata">
                         <source src="${media.media_file}" type="video/mp4">
                         Your browser does not support the video tag.
                       </video>`
                    }
                  </div>
                `).join('') : '<div class="text-gray-500">No media available</div>'}
              </div>
              
              ${hasMultipleMedia ? `
                <!-- Navigation arrows -->
                <button id="prevSlide" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 text-gray-700 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-100 shadow-md">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                  </svg>
                </button>
                <button id="nextSlide" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-80 text-gray-700 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-100 shadow-md">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
                
                <!-- Dots indicator -->
                <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
                  ${post.media_files.map((_, index) => `
                    <div class="w-2 h-2 rounded-full ${index === 0 ? 'bg-white' : 'bg-white bg-opacity-50'}" data-slide="${index}"></div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- Content Section -->
          <div class="w-96 flex flex-col">
            <!-- Header -->
            <div class="flex items-center p-4 border-b border-gray-200">
              <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mr-3">
                <span class="text-white text-sm font-bold">${post.author?.username?.charAt(0).toUpperCase() || 'U'}</span>
              </div>
              <div class="flex-1">
                <h3 class="font-semibold text-sm">${post.author?.username || 'Unknown'}</h3>
                ${post.location ? `<p class="text-xs text-gray-500">${post.location}</p>` : ''}
              </div>
              <button class="text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                </svg>
              </button>
            </div>
            
            <!-- Comments Section -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4 max-h-96">
              <!-- Caption -->
              ${post.caption ? `
                <div class="flex space-x-3">
                  <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-sm font-bold">${post.author?.username?.charAt(0).toUpperCase() || 'U'}</span>
                  </div>
                  <div class="flex-1">
                    <span class="font-semibold text-sm">${post.author?.username || 'Unknown'}</span>
                    <span class="text-sm ml-2">${post.caption}</span>
                    <p class="text-xs text-gray-500 mt-1">${formatDate(post.created_at)}</p>
                  </div>
                </div>
              ` : ''}
              
              <!-- Comments -->
              <div id="commentsContainer">
                ${post.comments ? post.comments.map(comment => `
                  <div class="flex space-x-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                      <span class="text-white text-sm font-bold">${comment.author?.username?.charAt(0).toUpperCase() || 'U'}</span>
                    </div>
                    <div class="flex-1">
                      <span class="font-semibold text-sm">${comment.author?.username || 'Unknown'}</span>
                      <span class="text-sm ml-2">${comment.text}</span>
                      <p class="text-xs text-gray-500 mt-1">${formatDate(comment.created_at)}</p>
                    </div>
                  </div>
                `).join('') : ''}
              </div>
            </div>
            
            <!-- Post Info -->
            <div class="border-t border-gray-200 p-4">
              <div class="mb-2">
                <span class="font-semibold text-sm">${post.likes_count || 0} likes</span>
              </div>
              <p class="text-xs text-gray-500 uppercase tracking-wide">${formatDate(post.created_at)}</p>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
      
      // Initialize carousel if multiple media
      if (hasMultipleMedia) {
        initializeCarousel(post.media_files.length);
      }
    }
    
    function closePostModal() {
      const modal = document.getElementById('postModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
      }
    }
    
    function initializeCarousel(totalSlides) {
      let currentSlide = 0;
      const slides = document.getElementById('mediaSlides');
      const prevBtn = document.getElementById('prevSlide');
      const nextBtn = document.getElementById('nextSlide');
      const dots = document.querySelectorAll('[data-slide]');
      
      function updateCarousel() {
        const translateX = -currentSlide * 100;
        slides.style.transform = `translateX(${translateX}%)`;
        
        // Update dots
        dots.forEach((dot, index) => {
          if (index === currentSlide) {
            dot.classList.remove('bg-opacity-50');
            dot.classList.add('bg-white');
          } else {
            dot.classList.add('bg-opacity-50');
            dot.classList.remove('bg-white');
          }
        });
      }
      
      prevBtn.onclick = () => {
        currentSlide = currentSlide > 0 ? currentSlide - 1 : totalSlides - 1;
        updateCarousel();
      };
      
      nextBtn.onclick = () => {
        currentSlide = currentSlide < totalSlides - 1 ? currentSlide + 1 : 0;
        updateCarousel();
      };
      
      dots.forEach((dot, index) => {
        dot.onclick = () => {
          currentSlide = index;
          updateCarousel();
        };
      });
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      
      if (diffInSeconds < 60) return 'Just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h`;
      if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d`;
      
      return date.toLocaleDateString();
    }
    
    
    // Post options menu functionality (same as home.html)
    document.addEventListener('DOMContentLoaded', function() {
      // Handle post options button clicks and touches
      document.addEventListener('click', handlePostOptionsClick);
      document.addEventListener('touchend', handlePostOptionsClick);
      
      function handlePostOptionsClick(e) {
        if (e.target.closest('.post-options-btn')) {
          e.preventDefault();
          e.stopPropagation();
          
          const btn = e.target.closest('.post-options-btn');
          const postId = btn.dataset.postId;
          const menu = document.querySelector(`.post-options-menu[data-post-id="${postId}"]`);
          
          // Close all other menus
          document.querySelectorAll('.post-options-menu').forEach(m => {
            if (m !== menu) m.classList.add('hidden');
          });
          
          // Toggle current menu
          menu.classList.toggle('hidden');
          
          // Add visual feedback for mobile
          if (e.type === 'touchend') {
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => {
              btn.style.transform = 'scale(1)';
            }, 150);
          }
        }
        
        // Close menu when clicking close button
        if (e.target.closest('.close-menu-btn')) {
          e.target.closest('.post-options-menu').classList.add('hidden');
        }
        
        // Handle delete post
        if (e.target.closest('.delete-post-btn')) {
          const postId = e.target.closest('.delete-post-btn').dataset.postId;
          deletePost(postId);
        }
        
        // Handle copy link
        if (e.target.closest('.copy-link-btn')) {
          const postId = e.target.closest('.copy-link-btn').dataset.postId;
          copyPostLink(postId);
        }
        
        // Handle share post
        if (e.target.closest('.share-post-btn')) {
          const postId = e.target.closest('.share-post-btn').dataset.postId;
          sharePost(postId);
        }
        
        // Handle edit post
        if (e.target.closest('.edit-post-btn')) {
          const postId = e.target.closest('.edit-post-btn').dataset.postId;
          editPost(postId);
        }
        
        // Handle hide likes
        if (e.target.closest('.hide-likes-btn')) {
          const postId = e.target.closest('.hide-likes-btn').dataset.postId;
          alert('Hide like count feature - Coming soon!');
          e.target.closest('.post-options-menu').classList.add('hidden');
        }
        
        // Handle toggle comments
        if (e.target.closest('.toggle-comments-btn')) {
          const postId = e.target.closest('.toggle-comments-btn').dataset.postId;
          alert('Toggle comments feature - Coming soon!');
          e.target.closest('.post-options-menu').classList.add('hidden');
        }
        
        // Handle go to post
        if (e.target.closest('.go-to-post-btn')) {
          const postId = e.target.closest('.go-to-post-btn').dataset.postId;
          window.location.href = `/posts/${postId}/`;
        }
        
        // Handle share to
        if (e.target.closest('.share-to-btn')) {
          const postId = e.target.closest('.share-to-btn').dataset.postId;
          sharePost(postId);
        }
        
        // Handle embed
        if (e.target.closest('.embed-btn')) {
          const postId = e.target.closest('.embed-btn').dataset.postId;
          alert('Embed feature - Coming soon!');
          e.target.closest('.post-options-menu').classList.add('hidden');
        }
        
        // Handle about account
        if (e.target.closest('.about-account-btn')) {
          alert('About this account - Coming soon!');
          e.target.closest('.post-options-menu').classList.add('hidden');
        }
        
        // Handle report post
        if (e.target.closest('.report-post-btn')) {
          const postId = e.target.closest('.report-post-btn').dataset.postId;
          reportPost(postId);
        }
        
        // Close menus when clicking outside
        if (!e.target.closest('.post-options-btn') && !e.target.closest('.post-options-menu')) {
          document.querySelectorAll('.post-options-menu').forEach(menu => {
            menu.classList.add('hidden');
          });
        }
      }
      
      // Add touch event handlers for better mobile support
      document.addEventListener('touchstart', function(e) {
        if (e.target.closest('.post-options-btn') || e.target.closest('.post-options-menu button')) {
          e.target.style.transform = 'scale(0.95)';
        }
      });
      
      document.addEventListener('touchend', function(e) {
        if (e.target.closest('.post-options-btn') || e.target.closest('.post-options-menu button')) {
          setTimeout(() => {
            e.target.style.transform = 'scale(1)';
          }, 150);
        }
      });
    });
    
    function deletePost(postId) {
      if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        // Create and submit form for delete
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/posts/${postId}/delete/`;
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = getCookie('csrftoken');
        
        form.appendChild(csrfToken);
        document.body.appendChild(form);
        form.submit();
      }
      
      // Close the menu
      const menu = document.querySelector(`.post-options-menu[data-post-id="${postId}"]`);
      if (menu) menu.classList.add('hidden');
    }
    
    function copyPostLink(postId) {
      const url = `${window.location.origin}/posts/${postId}/`;
      navigator.clipboard.writeText(url).then(() => {
        alert('Post link copied to clipboard!');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Post link copied to clipboard!');
      });
      
      // Close the menu
      const menu = document.querySelector(`.post-options-menu[data-post-id="${postId}"]`);
      if (menu) menu.classList.add('hidden');
    }
    
    function sharePost(postId) {
      const url = `${window.location.origin}/posts/${postId}/`;
      const text = 'Check out this post!';
      
      if (navigator.share) {
        navigator.share({
          title: 'Instagram Clone Post',
          text: text,
          url: url
        });
      } else {
        // Fallback - copy to clipboard
        copyPostLink(postId);
      }
      
      // Close the menu
      const menu = document.querySelector(`.post-options-menu[data-post-id="${postId}"]`);
      if (menu) menu.classList.add('hidden');
    }
    
    function editPost(postId) {
      // For now, just redirect to post detail (can be enhanced later)
      window.location.href = `/posts/${postId}/`;
      
      // Close the menu
      const menu = document.querySelector(`.post-options-menu[data-post-id="${postId}"]`);
      if (menu) menu.classList.add('hidden');
    }
    
    function reportPost(postId) {
      if (confirm('Are you sure you want to report this post?')) {
        alert('Post reported. Thank you for helping keep our community safe.');
        // Here you would typically send a report to the backend
      }
      
      // Close the menu
      const menu = document.querySelector(`.post-options-menu[data-post-id="${postId}"]`);
      if (menu) menu.classList.add('hidden');
    }
    
    // Toggle post options menu function
    function togglePostOptionsMenu(postId) {
      const menu = document.querySelector(`.post-options-menu[data-post-id="${postId}"]`);
      if (menu) {
        // Close all other menus first
        document.querySelectorAll('.post-options-menu').forEach(m => {
          if (m !== menu) m.classList.add('hidden');
        });
        
        // Toggle current menu
        menu.classList.toggle('hidden');
      }
    }
    
    // Post navigation functions
    let currentPostIndex = 0;
    let allPosts = [];
    
    function navigatePost(direction) {
      // Get all posts from the page
      const postElements = document.querySelectorAll('[data-post-id]');
      allPosts = Array.from(postElements).map(el => JSON.parse(el.dataset.postData));
      
      if (direction === 'next' && currentPostIndex < allPosts.length - 1) {
        currentPostIndex++;
      } else if (direction === 'prev' && currentPostIndex > 0) {
        currentPostIndex--;
      }
      
      // Close current modal and open new one
      closePostModal();
      setTimeout(() => {
        showPostModal(allPosts[currentPostIndex]);
      }, 100);
    }
    
    // Modal post options menu
    function toggleModalPostOptions() {
      // Create modal options menu if it doesn't exist
      let modalMenu = document.getElementById('modalPostOptionsMenu');
      if (!modalMenu) {
        modalMenu = document.createElement('div');
        modalMenu.id = 'modalPostOptionsMenu';
        modalMenu.className = 'absolute top-16 right-4 bg-white rounded-xl shadow-2xl py-2 w-56 z-30 border-0';
        modalMenu.style.boxShadow = '0 8px 30px rgba(0,0,0,0.12)';
        modalMenu.innerHTML = `
          <button class="w-full text-left px-4 py-4 text-sm text-red-500 hover:bg-red-50 font-semibold" onclick="deleteCurrentPost()">Delete</button>
          <div class="border-t border-gray-100 my-1"></div>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 font-medium" onclick="editCurrentPost()">Edit</button>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 font-medium" onclick="hideLikesCurrentPost()">Hide like count to others</button>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 font-medium" onclick="toggleCommentsCurrentPost()">Turn off commenting</button>
          <div class="border-t border-gray-100 my-1"></div>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 font-medium" onclick="goToCurrentPost()">Go to post</button>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 font-medium" onclick="shareCurrentPost()">Share to...</button>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 font-medium" onclick="copyCurrentPostLink()">Copy link</button>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 font-medium" onclick="embedCurrentPost()">Embed</button>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-800 hover:bg-gray-50 font-medium" onclick="aboutAccount()">About this account</button>
          <div class="border-t border-gray-100 my-1"></div>
          <button class="w-full text-left px-4 py-4 text-sm text-gray-600 hover:bg-gray-50 font-medium" onclick="closeModalMenu()">Cancel</button>
        `;
        document.getElementById('postModal').appendChild(modalMenu);
      }
      
      modalMenu.classList.toggle('hidden');
    }
    
    // Modal menu action functions
    function deleteCurrentPost() {
      if (allPosts[currentPostIndex] && confirm('Are you sure you want to delete this post?')) {
        deletePost(allPosts[currentPostIndex].id);
      }
    }
    
    function editCurrentPost() {
      if (allPosts[currentPostIndex]) {
        window.location.href = `/posts/${allPosts[currentPostIndex].id}/`;
      }
    }
    
    function hideLikesCurrentPost() {
      alert('Hide like count feature - Coming soon!');
      closeModalMenu();
    }
    
    function toggleCommentsCurrentPost() {
      alert('Toggle comments feature - Coming soon!');
      closeModalMenu();
    }
    
    function goToCurrentPost() {
      if (allPosts[currentPostIndex]) {
        window.location.href = `/posts/${allPosts[currentPostIndex].id}/`;
      }
    }
    
    function shareCurrentPost() {
      if (allPosts[currentPostIndex]) {
        sharePost(allPosts[currentPostIndex].id);
      }
    }
    
    function copyCurrentPostLink() {
      if (allPosts[currentPostIndex]) {
        copyPostLink(allPosts[currentPostIndex].id);
      }
    }
    
    function embedCurrentPost() {
      alert('Embed feature - Coming soon!');
      closeModalMenu();
    }
    
    function aboutAccount() {
      alert('About this account - Coming soon!');
      closeModalMenu();
    }
    
    function closeModalMenu() {
      const modalMenu = document.getElementById('modalPostOptionsMenu');
      if (modalMenu) modalMenu.classList.add('hidden');
    }
    
    // Close menus when clicking outside
    document.addEventListener('click', function(event) {
      if (!event.target.closest('.post-options-btn') && !event.target.closest('.post-options-menu')) {
        document.querySelectorAll('.post-options-menu').forEach(menu => {
          menu.classList.add('hidden');
        });
      }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closePostModal();
        // Also close any open post options menus
        document.querySelectorAll('.post-options-menu').forEach(menu => {
          menu.classList.add('hidden');
        });
      }
    });
  </script>
{% endblock %}
