{% extends 'base.html' %}
{% block content %}
<div class="bg-white min-h-screen w-full">
  <div class="w-full max-w-4xl mx-auto px-4 md:px-8 lg:px-16 pt-8 pb-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl md:text-3xl font-light">Follow Requests</h1>
        {% if total_requests > 0 %}
          <span class="bg-red-500 text-white text-sm font-medium px-3 py-1 rounded-full">{{ total_requests }}</span>
        {% endif %}
      </div>
      {% if total_requests > 0 %}
        <p class="text-gray-600">{{ total_requests }} people want to follow you</p>
      {% endif %}
    </div>

    <!-- Follow Requests List -->
    {% if follow_requests %}
      <div class="space-y-4">
        {% for follow_request in follow_requests %}
          <div class="border-b border-gray-200 pb-6 follow-request-item" data-request-id="{{ follow_request.id }}">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                {% if follow_request.from_user.profile.profile_picture %}
                  <img src="{{ follow_request.from_user.profile.profile_picture.url }}" alt="{{ follow_request.from_user.username }}" class="w-14 h-14 rounded-full object-cover">
                {% else %}
                  <div class="w-14 h-14 bg-gradient-to-br from-pink-400 via-red-500 to-yellow-500 rounded-full flex items-center justify-center">
                    <svg class="w-7 h-7 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                {% endif %}
                <div class="flex-1">
                  <div class="flex items-center space-x-2">
                    <h3 class="font-semibold text-base">{{ follow_request.from_user.username }}</h3>
                    <span class="text-gray-400 text-sm">â€¢</span>
                    <p class="text-gray-400 text-sm">{{ follow_request.created_at|timesince }} ago</p>
                  </div>
                  {% if follow_request.from_user.first_name %}
                    <p class="text-gray-600 text-sm">{{ follow_request.from_user.first_name }} {{ follow_request.from_user.last_name }}</p>
                  {% endif %}
                  {% if follow_request.from_user.profile.bio %}
                    <p class="text-gray-600 text-sm mt-1">{{ follow_request.from_user.profile.bio|truncatewords:15 }}</p>
                  {% endif %}
                </div>
              </div>
              
              <div class="flex space-x-3 flex-shrink-0">
                <button onclick="acceptRequest({{ follow_request.id }})" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold text-sm px-6 py-2 rounded-md transition-colors accept-btn">
                  Confirm
                </button>
                <button onclick="declineRequest({{ follow_request.id }})" class="bg-gray-100 hover:bg-gray-200 text-black font-semibold text-sm px-6 py-2 rounded-md transition-colors decline-btn">
                  Delete
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    <!-- Pagination -->
    {% if follow_requests.has_other_pages %}
      <div class="flex justify-center mt-12">
        <nav class="flex space-x-4">
          {% if follow_requests.has_previous %}
            <a href="?page={{ follow_requests.previous_page_number }}" class="bg-gray-100 hover:bg-gray-200 text-black font-semibold px-4 py-2 rounded-md text-sm transition-colors">Previous</a>
          {% endif %}
          
          <span class="bg-blue-500 text-white font-semibold px-4 py-2 rounded-md text-sm">
            Page {{ follow_requests.number }} of {{ follow_requests.paginator.num_pages }}
          </span>
          
          {% if follow_requests.has_next %}
            <a href="?page={{ follow_requests.next_page_number }}" class="bg-gray-100 hover:bg-gray-200 text-black font-semibold px-4 py-2 rounded-md text-sm transition-colors">Next</a>
          {% endif %}
        </nav>
      </div>
    {% endif %}
    {% else %}
      <!-- No Requests Message -->
      <div class="text-center py-16">
        <div class="border-2 border-gray-300 rounded-full w-20 h-20 mx-auto mb-6 flex items-center justify-center">
          <svg class="w-10 h-10 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
          </svg>
        </div>
        <h2 class="text-3xl font-light text-gray-700 mb-4">No follow requests</h2>
        <p class="text-gray-500">When people request to follow you, their requests will appear here.</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
function acceptRequest(requestId) {
  const item = document.querySelector(`[data-request-id="${requestId}"]`);
  const acceptBtn = item.querySelector('.accept-btn');
  const declineBtn = item.querySelector('.decline-btn');
  
  acceptBtn.textContent = 'Accepting...';
  acceptBtn.disabled = true;
  
  fetch(`/follow/accept-request/${requestId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      item.style.opacity = '0.5';
      acceptBtn.textContent = 'Accepted';
      acceptBtn.className = 'bg-green-500 text-white text-xs px-3 py-1 rounded-md';
      declineBtn.style.display = 'none';
      
      setTimeout(() => {
        item.remove();
        updateRequestCount(-1);
      }, 1500);
    } else {
      acceptBtn.textContent = 'Accept';
      acceptBtn.disabled = false;
      alert('Error accepting request');
    }
  })
  .catch(error => {
    acceptBtn.textContent = 'Accept';
    acceptBtn.disabled = false;
    alert('Error accepting request');
  });
}

function declineRequest(requestId) {
  const item = document.querySelector(`[data-request-id="${requestId}"]`);
  const acceptBtn = item.querySelector('.accept-btn');
  const declineBtn = item.querySelector('.decline-btn');
  
  declineBtn.textContent = 'Declining...';
  declineBtn.disabled = true;
  
  fetch(`/follow/decline-request/${requestId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    },
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      item.style.opacity = '0.5';
      declineBtn.textContent = 'Declined';
      declineBtn.className = 'bg-red-500 text-white text-xs px-3 py-1 rounded-md';
      acceptBtn.style.display = 'none';
      
      setTimeout(() => {
        item.remove();
        updateRequestCount(-1);
      }, 1500);
    } else {
      declineBtn.textContent = 'Decline';
      declineBtn.disabled = false;
      alert('Error declining request');
    }
  })
  .catch(error => {
    declineBtn.textContent = 'Decline';
    declineBtn.disabled = false;
    alert('Error declining request');
  });
}

function updateRequestCount(change) {
  const badge = document.querySelector('.bg-red-500');
  if (badge) {
    const currentCount = parseInt(badge.textContent);
    const newCount = currentCount + change;
    if (newCount <= 0) {
      location.reload(); // Reload to show "no requests" message
    } else {
      badge.textContent = newCount;
    }
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}